
# title "Pràctica_2"
## Authors
"Roger Alvarez"
"Xavier Borrat"

date: "2023-01-06"
output: pdf_document

LINKS a les fonts de les dades:


https://archive.ics.uci.edu/ml/datasets/Heart+Disease

https://www.kaggle.com/datasets/rashikrahmanpritom/heart-attack-analysis-prediction-dataset



### 1. Descripció del dataset. Perquè és important i quina pregunta/problema pretén respondre?

El dataset de treball es una modificació d'un dataset original del que hem pogut treure més informació per entendre millor les variables. (https://archive.ics.uci.edu/ml/datasets/Heart+Disease)

El dataset de treball  conté informació sobre pacients que consulten sobre diferent simptomatologia de probable origen  cardíac. Aquesta informació es el resultat de registrar la resposta a diferents preguntes i proves per determinar si els simptomes corresponen a obstrucció coronària verificada per una angiografia coronoria. L'angiografia o cateterisme es la prova "gold standard" per a determinar si un pacient està patint o té un alt risc de patir un infart de cor. 

Al dataset hi ha diferents variables que descriuen diferents aspectes dels pacients, com ara l'edat(age), el gènere(sex), si han experimentat dolor de pit durant l'exercici físic(exang), el nombre de vasos sanguinis calcificats en una radiografia continua(escopia)(ca), el tipus de dolor de pit que han experimentat(cp), la pressió arterial en repòs(trtbps), la quantitat de colesterol en sang(chol), si han fet una prova de tolerància a la glucosa en dejú(fbs), el resultat de l'electrocardiograma en repòs(rest_ecg) i la freqüència cardíaca màxima aconseguida durant la prova d'esforç(thalach). Totes aquestes variables actuarien com a potencials predictors de risc de presentar o no obstrucció de les artèries coronàries. 

Finalment hi ha una variable diana que indica si el pacient té més o menys probabilitats de patir un atac de cor mesurat a través de l'obtrucció dels vasos coronaris a través d'un catetisme cardíac. 


```{r}
library(VIM)
library(caret)
library(ggplot2)
setwd("~/Documents/GitHub/datathon2021/heart_attack")
# Carrega  de l'arxiu de dades

heart <- read.csv("heart.csv")
```

### 2. Integració i selecció de les dades d’interès a analitzar. Pot ser el resultat d’addicionar diferents datasets o una subselecció útil de les dades originals, en base a l’objectiu que es vulgui aconseguir.

```{r}
# 2. Integracció i selecció
# Seleccionem les columnes que volem:

heart_sel<- heart[c("age", "sex", "trtbps", "chol", "fbs", "restecg", "exng", "caa", "output")]

# Convertim a tipus factor les variables discretes.

#sex: sex (1 = male; 0 = female) 
heart_sel$sex<-factor(heart_sel$sex)

#fbs: (fasting blood sugar > 120 mg/dl) (1 = true; 0 = false) 
heart_sel$fbs<-factor(heart_sel$fbs)

#restecg: Lectures de Electrocardiograma  en repòs.
#Value 0: normal
#Value 1: having ST-T wave abnormality
heart_sel$restecg<-factor(heart_sel$restecg)
heart_sel$exng<-factor(heart_sel$exng)


# output Value 0: < 50% diameter narrowing 
# output Value 1: > 50% diameter narrowing 
#heart_sel$output<-factor(heart_sel$output)

#Funció resum del dataset.
summary(heart_sel)



```
### 3. Neteja de les dades.



```{r}

# 3.1 0 Rastreig de  valors. En aquest cas no hi ha valors buits.

colSums(is.na(heart_sel))


```


Transformem la veriable restecg on passem de tres valors de la variable a nominal a només 2. El motiu és que clínicament un registre d'hipertrofia en el context de la malaltia coronària comptabilitazaria com a normal per tant el valor 2 el convertirem a valor 0.
```{r}
# En el cas de la variable restecg la convertim en dicotòmica convertint els valors 2 en 0. 

heart_sel$restecg[heart_sel$restecg == 2] <- 0
heart_sel$restecg<-factor(heart_sel$restecg)
table(heart_sel$restecg)
```

Indentificació de valors extrems(outlayer) utilitzarem com a definició una desviació de més de 1.5 vegades el rang interquantilic per sobre el quartil superior i per sota el quartil inferior  (Q1 - 1.5 * IQR or Q3 + 1.5 * IQR).
```{r}
# 3.2 valors extrems


boxplot(heart_sel$trtbps, main="Resting blood pressure")
rbp_outliers <- boxplot.stats(heart_sel$trtbps)$out
sort(rbp_outliers)

boxplot(heart_sel$chol, main="Colesterol level")
col_outliers <- boxplot.stats(heart_sel$chol)$out
sort(col_outliers) 

```

```{r}

# Encara que alguns dels valors  siguin plausibles i altres no, ens agafarem a la definicó estadísitca de outlayer (Q1 - 1.5 * IQR or Q3 + 1.5 * IQR) i imputaremm els seus valors amb una tècnica de "machine learning" KNN(k-nearest neighbours).

heart_sel$trtbps[heart_sel$trtbps >= min(rbp_outliers)] <- NA
heart_sel$chol[heart_sel$chol >= min(col_outliers)] <- NA


# Imputem valors nous utilitzan KNN.

heart_sel<- kNN(heart_sel, variable= "trtbps", k = 11)
heart_sel<- kNN(heart_sel, variable= "chol", k = 11)


```

### 4. Anàlisi de les dades.
4.1. Selecció dels grups de dades que es volen analitzar/comparar (p. e., si es volen comparar grups de dades, quins són aquests grups i quins tipus d’anàlisi s’aplicaran?).
**Objectiu principal**:
Amb aquest conjunt de dades volem saber si podem generar un model predictiu per estimar el diagnòstic de malaltia coronaria a partir de dades biomètriques, analítiques i de tests d'estrés. 

Regressio logística per predir la malaltia coronaria utilitzant com a variables independents:
-Edat(Age)
-Sexe(Sex)
-Glicèmia basal com a marcador de diabetis.(fps)
-Colesterol en sang.(chol)
-Pressió arterial en repòs.(trtbpm)
-Dolor en repòs.(exng)
-Alteració segment ST en repòs.(restecg)
-Nombre d'arteries coronaries calcificades. (output)

**Objectiu Secundari**
Abans però volem estudiar el comportament d'algunes variables entre elles:

1.-Relació entre dolor anginós en exercici (exng) i presentar elevació del segment ST(restecg) com a marcador d'isquèmia miocàrdica. 
Matriu de confusió:
exng, restecg

```{r}
# Relació entre dolor anginós a l'exercici (exng) i presentar elevació del segment ST(restecg) com a marcador d'isquèmia miocàrdica. 

#H0: The two variables are independent.
#H1: The two variables relate to each other.

chisq.test(heart_sel$exng, heart_sel$restecg)


```

Conclusió: No hi ha relació entre la ocorrència d'aquests dos fets i per tant son indendents. Tot i que el dolor precordial en repòs és altament suggestiu de coronariopatia,  no s'associa a elevació del segment ST en repós ja que aquesta mesura en aquest dataset s'obté en el context  d'una prova d'esforç que es una prova per diagnosticar angines d'esforç i no angines de repòs. Per tant quan hi ha dolor en repós la prova diagnótica a fer no es una prova d'esforç per això es plausible que en aquest context les variables pughin ser independents. 


2.-Quin és el nivell de relació entre:
-edat(age) vs colesterol(chol) 
-edat(age) vs. pressió arterial en repòs(trtbps). 

Correlació:
edat vs colesterol 
edat vs pressió arterial en repòs



```{r}
# Quin és el nivell de relació entre edat(age) i colesterol(chol) i edat i pressió arterial en repós(trtbps). 

# Comprovem la normalitat de les distribucions de les dades mitjançant el test shapiro-wilkins i l'aproximició gràfica amb un normograma QQ.

# The null-hypothesis of this test is that the population is normally distributed.

shapiro.test(heart_sel$age) 
shapiro.test(heart_sel$chol)
shapiro.test(heart_sel$trtbps)

qqnorm(heart_sel$age)
qqline(heart_sel$age)
qqnorm(heart_sel$chol)
qqline(heart_sel$chol)
qqnorm(heart_sel$trtbps)
qqline(heart_sel$trtbps)

```
Tots els  tests ni normogrames QQ ens indiquen que la distribució de les dades no és normal i per tant aplicarem per veure la correlació entre elles el test de rangs de kendall per a variables de distribuió no normal i que a més tingui capacitat de treballar si dos ocurrències cauen dintre el mateix rang. 

```{r}
# La correlació de rangs de Kendall o Tau s'utilitza per estimar la mesura de l'associació de dues variables continues a partir de rangs. Aquest test es pot utilitzar en dades que no siguin normals i a diferencia del test d'spearman pot tractar amb dades que cauen dintre del mateix rang. 

plot(heart_sel$age, heart_sel$chol, main="Age vs Colesterol",
xlab="Age", ylab="Colesterol in blood", pch=19)
abline(lm(chol ~ age, data = heart_sel), col = "blue")


cor.test(heart_sel$age, heart_sel$chol,method = 'kendall',use = "complete.obs")

plot(heart_sel$age, heart_sel$trtbps, main="Age vs rest arterial pressure",
xlab="Age", ylab="Resting blood pressure", pch=19)
abline(lm(trtbps ~ age, data = heart_sel), col = "blue")

cor.test(heart_sel$age, heart_sel$trtbps,method = 'kendall',use = "complete.obs") 


```
Resultats i conclusion: 
Tant en els gràfics com en els tests s'observa que tant la correlació entre edad i colesterol com edad i pressió arterial en repòs no estan associades com evidencia un gràfic amb distribució tipus núvol i una tau de 0.1.

```{r}
#Performs a Fligner-Killeen (median) test of the null that the variances in each of the groups (samples) are the same. For non normal distributions. 
fligner.test(age ~ sex, data = heart_sel)
fligner.test(trtbps ~ sex, data = heart_sel)
fligner.test(chol ~ sex, data = heart_sel)
```
Conclusió: Les distribucions de les variables continues només la presió arterial en repós presenta homocedasticitat.

```{r}
# 3.- Comparar si homes i dones tenen un nivell de colesterol i pressió arterial igual o diferent. 

# Previament verificar si l'edat d'homes i dones d'aquesta cohort es comparable. 

# Cap de les variables continues té criteris per poder aplicar el test t-student perquè no partim de distribucions normals i tampoc dues d'elles compleixen el criteri d'homocedasticitat. 


# Pel teorema del límit central podem assumir normalitat de la distribució de les mitges mostrals.


# Comparació de les edats pels diferents sexes.

boxplot(heart_sel$age ~ heart_sel$sex, main="Age vs gender",
        xlab="Gender: 0= Female, 1 = Male", ylab="Age")

mitges<- with(heart_sel,tapply(age,sex,mean))
desvest<-with(heart_sel,tapply(age,sex,sd))
n<-with(heart_sel,tapply(age,sex,length))

SE.1 <-  desvest[1] / sqrt(n[1])               
SE.2 <-  desvest[2] / sqrt(n[2])  
SE      <- sqrt( SE.1^2 + SE.2^2)                        
z       <- (mitges[1] - mitges[2]) / SE
P.z     <- pnorm(z, lower.tail = FALSE) 
print(SE)
print(z)
print(P.z)


```




```{r}
boxplot(heart_sel$chol ~ heart_sel$sex, main="Colesterol vs gender",
        xlab="Gender: 0= Female, 1 = Male", ylab="Colesterol level in blood")

mitges<- with(heart_sel,tapply(chol,sex,mean))
desvest<-with(heart_sel,tapply(chol,sex,sd))
n<-with(heart_sel,tapply(chol,sex,length))

SE.1 <-  desvest[1] / sqrt(n[1])               
SE.2 <-  desvest[2] / sqrt(n[2])  
SE      <- sqrt( SE.1^2 + SE.2^2)                        
z       <- (mitges[1] - mitges[2]) / SE
P.z     <- pnorm(z, lower.tail = FALSE) 
print("Desviació estandard")
print(SE)
print("Diferencia de mitges entre grups")
print(mitges[1]-mitges[2])
print("estadístic Z")
print(z)
print("probabilitat de rebutjar siguent certa la hipotesis nul·la")
print(P.z)

```

```{r}
boxplot(heart_sel$trtbps ~ heart_sel$sex, main="Blood resting pressure vs gender",
        xlab="Gender: 0= Female, 1 = Male", ylab="Blood resting pressure")

mitges<- with(heart_sel,tapply(trtbps,sex,mean))
desvest<-with(heart_sel,tapply(trtbps,sex,sd))
n<-with(heart_sel,tapply(trtbps,sex,length))

SE.1 <-  desvest[1] / sqrt(n[1])               
SE.2 <-  desvest[2] / sqrt(n[2])  
SE      <- sqrt( SE.1^2 + SE.2^2)                        
z       <- (mitges[1] - mitges[2]) / SE
P.z     <- pnorm(z, lower.tail = FALSE) 

print(SE)
print(z)
print(P.z)
```


```{r}

# regressió logistica


mod1 <- glm(output ~ age+sex+trtbps+chol+fbs+restecg+exng+caa, family = binomial, data = heart_sel)
summary(mod1)
```


```{r}

# Càlcul de les OR (Odds-Ràtio)
exp(coefficients(mod1))


```


